function getCookie(n){var i="; "+document.cookie,t=i.split("; "+n+"=");if(t.length===2)return t.pop().split(";").shift()}function isNumber(n){return!isNaN(parseFloat(n))&&isFinite(n)}function scrollTo(n,t,i){function e(n){document.documentElement.scrollTop=n;document.body.parentNode.scrollTop=n;document.body.scrollTop=n}function o(){return document.documentElement.scrollTop||document.body.parentNode.scrollTop||document.body.scrollTop}var f=o(),s=n-f,r=0,h=20,u;i=typeof i=="undefined"?500:i;u=function(){r+=h;var n=Math.easeInOutQuad(r,f,s,i);e(n);r<i?requestAnimFrame(u):t&&typeof t=="function"&&t()};u()}function scrollBottomTop(n){var t=document.documentElement,i=document.body,r="scrollTop",u="scrollHeight",e=(t[r]||i[r])/((t[u]||i[u])-t.clientHeight),f;e>.8?scrollTo(0):(f=Math.max(i.scrollHeight||0,i.clientHeight||0,t.clientHeight||0,t.scrollHeight||0,t.clientHeight||0),scrollTo(f));n.preventDefault()}function humanFileSize(n,t){var r=t?1e3:1024,u,i;if(Math.abs(n)<r)return n+" B";u=t?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];i=-1;do n/=r,++i;while(Math.abs(n)>=r&&i<u.length-1);return n.toFixed(1)+" "+u[i]}function setLoading(n){var t=document.getElementById("load_spinner"),i=document.getElementById("logo");n?(t.style.display="inline",i.style.display="none"):(t.style.display="none",i.style.display="inline")}function setTitle(n){titleWithoutCount=n;document.title=isNumber(notification_count)?notification_count>0?"("+notification_count+") "+n:n:"("+notification_count+") "+n}function setNotifications(){notification_count=notification_count<0?0:notification_count;var n=document.getElementById("notif_count");n.innerHTML=notification_count;n.style.backgroundColor=isNumber(notification_count)?notification_count===0?"green":"orange":"red";setTitle(titleWithoutCount)}function setState(n,t,i,r){r?window.history.replaceState(n,t,i):window.history.pushState(n,t,i)}function getLastUrlElement(n){var i="",r=new URL(n),t;return r.pathname!=="/"&&(t=r.pathname.split("/"),i=t[t.length-1]),i}function tableElement(n,t){var i=document.createElement(n);return i.innerHTML=t,i}function formatDate(n){return new Date(n).toString().replace(/\S+\s(\S+)\s(\d+)\s(\d+)\s.*/,"$2. $1 $3")}function createRow(n){var f=document.createElement("tr"),r,t,u;const i=["title","saved","domain","details"];for(r in i)t="",i[r]==="title"?(u=document.createElement("a"),u.href="/s/"+(n.pagepath.endsWith("/index.html")||n.pagepath.endsWith("index.html")?n.id+"/":n.pagepath),u.innerText=n.title,t=u.outerHTML):i[r]==="domain"?t='<a href="/site/'+n.domain+'">'+n.domain+"<\/a>":i[r]==="details"?t='<a href="/details/'+n.id+'">Details<\/a>':i[r]==="saved"&&(t=formatDate(n.saved)),f.appendChild(tableElement("td",t));return f}function DisplayError(n){n=n||"An unknown error occured.";var t="/";state.isDetails?t="/details/"+state.data:state.isNew?t="/new":state.isTable&&state.data!==""&&(t="/site/"+state.data);document.getElementById("content").innerHTML='<div class="uk-placeholder uk-text-center" style="color: red">'+n+'<br><a href="'+t+'">Try again<\/a><\/div>';setTitle("Error - Collect");document.getElementById("title").innerText="Error";setState(state,document.title,location.protocol+"//"+location.host+t,!0);setEventListeners()}function urlencodeFormData(n){var i=[];for(var t in n)n.hasOwnProperty(t)&&i.push(encodeURIComponent(t)+"="+encodeURIComponent(n[t]));return i.join("&")}function fillVideoText(){var n=document.getElementById("url");n.value.startsWith("video:")||(n.value="video:"+n.value);n.focus()}function setEventListeners(){var f,e,v,o,y,s,h,c,l,n,a,u;if(location.pathname!=="/login"){for(f=function(n){var t=getLastUrlElement(this.href);LoadTable(t);n.preventDefault()},e=document.querySelectorAll('a[href="/"]'),n=0;n<e.length;n++)e[n].onclick=f;for(document.getElementById("title").onclick=scrollBottomTop,v=function(n){LoadNew();n.preventDefault()},o=document.querySelectorAll('a[href="/new"]'),n=0;n<o.length;n++)o[n].onclick=v;if(state.isTable)for(y=function(n){var t=getLastUrlElement(this.href);LoadDetails(t);n.preventDefault()},s=document.querySelectorAll('a[href^="/details/"]'),n=0;n<s.length;n++)s[n].onclick=y;if(state.isDetails&&(h=document.getElementById("delete"),h&&(h.onclick=SubmitDeleteEntry),c=document.getElementById("submit"),c&&(c.onclick=SubmitChangeTitle)),state.isTable||state.isDetails)for(l=document.querySelectorAll('a[href^="/site/"]'),n=0;n<l.length;n++)l[n].onclick=f;if(state.isNew){a=document.getElementById("new_form");a&&(a.onsubmit=SubmitNewForm);document.getElementById("new-video").onclick=fillVideoText;var r=document.getElementById("depth"),t=document.getElementById("samedomain"),i=document.createElement("option");i.hidden=!0;i.disabled=!0;i.value="followNone";i.innerText="Don't follow any hyperlinks";u=function(){var n=!(isNumber(r.value)&&r.value<=5&&r.value>0);n?t.children.length===2&&(t.appendChild(i),t.value="followNone"):t.children.length===3&&t.removeChild(i);t.disabled=n};u();r.onchange=u;r.oninput=u}}}function SubmitNewForm(n){var t={title:document.getElementById("n_title").value,url:document.getElementById("url").value,depth:document.getElementById("depth").value,samedomain:document.getElementById("samedomain").value==="followSame",cookies:document.getElementById("cookies").value,useragent:document.getElementById("useragent").value};setLoading(!0);ajax("/api/v1/site/add",t).post(function(n,t){var i=document.getElementById("error_field");if(n===202)return i.style.visibility="hidden",LoadTable();i.innerHTML='<p class="uk-text-center">'+t.message+"<\/p>";i.style.visibility="visible";setLoading(!1)});n.preventDefault()}function SubmitDeleteEntry(n){var t=state.data;setLoading(!0);ajax("/api/v1/site/"+t+"/delete",null).post(function(n,t){if(n===200)return LoadTable();var i=document.getElementById("d_err"),r=document.getElementById("d_err_mess");i.className="uk-alert-danger";i.style.display="block";r=t.message||"Unknown error";setLoading(!1)});n.preventDefault()}function SubmitChangeTitle(n){var i=state.data,t;t_prevent_reload=!0;setLoading(!0);t={title:document.getElementById("d_title").value};ajax("/api/v1/site/"+i+"/settitle",t).post(function(n,t){var i=document.getElementById("d_err"),r=document.getElementById("d_err_mess");i.className=n===200?"uk-alert-success uk-alert":"uk-alert-danger uk-alert";r.innerText=t.message||"Unknown error";i.style.display="block";setLoading(!1);setTimeout(function(){i.style.display="none"},n_timeout)});n.preventDefault()}function LoadTable(n,t){n=n||"";t=t||!1;state.data=n;state.isDetails=!1;state.isNew=!1;state.isTable=!0;setLoading(!0);ajax("/api/v1/sites/"+n,null).get(function(i,r){var f=document.getElementById("content"),e,s,u,h,c,l,y,o,a,v;if(i===200)if(r.length>0){e=document.createElement("table");e.className="uk-table uk-table-striped uk-table-hover uk-table-responsive";s=document.createElement("thead");u=document.createElement("tr");u.appendChild(tableElement("th","Title"));u.appendChild(tableElement("th","Date"));u.appendChild(tableElement("th","Domain"));u.appendChild(tableElement("th","Details"));s.appendChild(u);e.appendChild(s);h=document.createElement("tbody");c=0;for(l in r)h.appendChild(createRow(r[l])),c+=r[l].size;e.appendChild(h);f.innerHTML="";f.appendChild(e);y="There "+(r.length===1?"is":"are")+" "+r.length+" item"+(r.length===1?"":"s")+((n||"")===""?"":" for this domain")+" with a size of about "+humanFileSize(c,!0);o=document.createElement("div");o.className="uk-text-center uk-margin-small uk-text-muted uk-text-small";o.innerText=y;f.appendChild(o)}else f.innerHTML='<div class="uk-placeholder uk-text-center">There are no archived sites.<br><a href="/new">Add a new site to your archive<\/a><\/div>';else a="An unknown error occurred.",(r||{}).message&&(a="Error: "+r.message),f.innerHTML='<div class="uk-placeholder uk-text-center" style="color:red">'+a+'<br><a href="'+(n===""?"/":"/site/"+n)+'">Try again<\/a><\/div>';setLoading(!1);v=n===""?"All Sites":n;setTitle(v+" - Collect");document.getElementById("title").innerText=v;setState(state,document.title,location.protocol+"//"+location.host+(n===""?"/":"/site/"+n),t);setEventListeners()})}function LoadDetails(n,t){if(t=t||!1,n===null||n==="")throw new ReferenceError("Missing parameter id");state.data=n;state.isDetails=!0;state.isNew=!1;state.isTable=!1;setLoading(!0);ajax("/api/v1/details/"+n,null).get(function(i,r){var k=document.getElementById("content"),s,a,e,h,o,f,v,y,w,u,b,p,c,l;if(i===200){for(s=document.createElement("div"),s.className="uk-alert-success",s.id="d_err",s["uk-alert"]="",s.style.display="none",a=document.createElement("p"),a.className="uk-text-center",a.id="d_err_mess",a.innerText="",s.appendChild(a),e=document.createElement("form"),e.appendChild(s),e.id="details_form",e.action="/details/"+r.id,e.method="POST",e.className="uk-form-horizontal uk-margin-large",h=["Url","Path","Size","Id","Domain","Saved","Title"],o=0;o<h.length;o++){if(f=h[o]==="Path"?"pagepath":h[o].toLowerCase(),v=document.createElement("div"),v.className="uk-margin",y=document.createElement("label"),y.className="uk-form-label",y.htmlFor="form-horizontal-text",y.innerText=h[o]==="Size"?"Size on disk":h[o],v.appendChild(y),w=document.createElement("div"),w.className="uk-form-controls",v.appendChild(w),u=null,["url","pagepath","domain"].some(function(n){return n===f})){u=document.createElement("a");switch(f){case"url":u.href=r.url;u.innerText=r.url;u.target="_blank";break;case"pagepath":b=r.pagepath.endsWith("/index.html")||r.pagepath.endsWith("index.html")?r.id+"/":r.pagepath;u.href="/s/"+b;u.innerText=b;break;case"domain":u.href="/site/"+r.domain;u.innerText=r.domain}u.id=f}else u=document.createElement("input"),u.name=f,u.type="text",u.placeholder=h[o],u.value=f==="saved"?formatDate(r[f]):f==="size"?humanFileSize(r.size,!0):r[f],f!=="title"?(u.disabled=!0,u.id=f):u.id="d_title";u.classList="uk-input";w.appendChild(u);e.appendChild(v)}p=document.createElement("div");p.className="uk-margin";c=document.createElement("button");c.innerText="Submit";c.name="submit";c.className="uk-button uk-button-primary button-submit";c.type="submit";c.id="submit";p.appendChild(c);l=document.createElement("button");l.innerText="Delete";l.name="delete";l.className="uk-button uk-button-danger button-reset";l.type="submit";l.id="delete";p.appendChild(l);e.appendChild(p);k.innerHTML="";k.appendChild(e)}else DisplayError((r||{}).message);setLoading(!1);setTitle("Details - Collect");document.getElementById("title").innerText="Details";setState(state,document.title,location.protocol+"//"+location.host+"/details/"+n,t);setEventListeners()})}function LoadNew(n){n=n||!1;state.data=null;state.isDetails=!1;state.isNew=!0;state.isTable=!1;document.getElementById("content").innerHTML='<form class="uk-form-horizontal uk-margin-large" id="new_form" method="POST" action="/new"> <div class="uk-alert-danger" uk-alert id="error_field" style="visibility:hidden;"><\/div><!-- Url--><div class="uk-margin"><label class="uk-form-label" for="form-horizontal-text">Url<\/label><div class="uk-form-controls"><input class="uk-input" id="url" type="url" name="url" autofocus placeholder="Url" value=""><\/div><\/div><!-- Depth--><div class="uk-margin"><label class="uk-form-label" for="form-horizontal-text">Depth<span class="uk-text-muted" title="If you don\'t set a depth, the default of zero will be used"> (optional)<\/span><\/label><div class="uk-form-controls"><input class="uk-input" id="depth" type="number" step="1" min="0" max="5" name="depth" placeholder="Depth" value=""><\/div><\/div><!-- SameDomain--><div class="uk-margin"><label class="uk-form-label" for="form-horizontal-text">Following Behaviour<\/label><div class="uk-form-controls"><select class="uk-select" name="samedomain" id="samedomain" placeholder="Following Behaviour"><option value="followAll">Follow all hyperlinks<\/option><option value="followSame">Only follow hyperlinks to the same domain<\/option><\/select><\/div><\/div><!-- Advanced options--><details><summary style="cursor: pointer;">Advanced options<\/summary><!-- Title--><div class="uk-margin"><label class="uk-form-label" for="form-horizontal-text">Title<span class="uk-text-muted" title="If you don\'t enter anything here, the title will be detected automatically"> (optional)<\/span><\/label><div class="uk-form-controls"><input class="uk-input" id="n_title" type="text" name="title" placeholder="Title" value=""><\/div><\/div><!-- Cookies--><div class="uk-margin"><label class="uk-form-label" for="form-horizontal-text">Cookies<span class="uk-text-muted" title="If you don\'t enter anything here, the request will be sent without any cookies"> (optional)<\/span><\/label><div class="uk-form-controls"><input class="uk-input" id="cookies" type="text" name="cookies" placeholder="cookie1=value1;cookie2=value2" value=""><\/div><\/div><!-- User-Agent--><div class="uk-margin"><label class="uk-form-label" for="form-horizontal-text">User-Agent<span class="uk-text-muted" title="If you don\'t enter anything here, the default user agent will be used"> (optional)<\/span><\/label><div class="uk-form-controls"><!-- By default the requests module doesn\'t send a user agent--><input class="uk-input" id="useragent" type="text" name="useragent" placeholder="Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.1" value=""><\/div><\/div><\/details><div class="uk-margin"><button class="uk-button uk-button-primary button-submit" type="submit">Submit<\/button><button class="uk-button uk-button-default button-reset" type="reset">Reset<\/button><\/div><\/form><br class="uk-margin-remove"><div class="uk-text-center uk-margin-small uk-text-muted ">Hint: You can write <span class="uk-text-primary" id="new-video">"video:"<\/span> before an url to download only the video.<\/div><\/div>';document.getElementById("url").focus();setTitle("New Entry - Collect");document.getElementById("title").innerText="New Entry";setState(state,document.title,location.protocol+"//"+location.host+"/new",n);setEventListeners()}function resolveCurrent(n){n=n||!1;state.isDetails?LoadDetails(state.data,n):state.isNew?LoadNew(n):LoadTable(state.data||"",n)}function registerKeyboardShortcuts(){window.addEventListener("keydown",function(n){return n.keyCode===27&&!(state.data===""&&state.isTable)?(n.preventDefault(),LoadTable(),!0):n.keyCode===86&&n.shiftKey&&state.isNew&&(n.target||{}).id==="url"?(n.preventDefault(),fillVideoText(),!1):n.target.tagName==="INPUT"?!1:n.keyCode===78&&!state.isNew?(n.preventDefault(),LoadNew(),!0):n.keyCode===32?(n.preventDefault(),scrollBottomTop(),!0):void 0})}var notification_count=0,needs_to_reload=!1,state={data:"",isTable:!1,isNew:!1,isDetails:!1},titleWithoutCount=document.title,t_prevent_reload=!1,n_timeout=3500,n_pos="bottom-right",requestAnimFrame,ajax;if(location.pathname!=="/login"){var notif_sound=Audio?new Audio("/notification_sound.ogg"):null,sess_cookie=getCookie("session_id"),socket=io(location.protocol+"//"+location.host,{query:{session_id:sess_cookie}});socket.on("url",function(n){var t,i;n.url.startsWith("video:")&&(n.url=n.url.substring(6));t=new URL(n.url);isNumber(notification_count)||(notification_count=0);i=t.hostname+(t.pathname==="/"?"":t.pathname);switch(n.step){case 0:UIkit.notification({message:'Started processing url <a href="'+n.url+'" target="_blank">'+i+"<\/a>",status:"primary",pos:n_pos,timeout:n_timeout});notification_count++;break;case 1:UIkit.notification({message:'The entry "<a href="/s/'+n.result.pagepath+'">'+n.result.title+'<\/a>" already exists',status:"primary",pos:n_pos,timeout:n_timeout});notification_count--;break;case 2:UIkit.notification({message:'<a style="color:#32d296" href="/s/'+n.result.pagepath+'">Finished processing "'+n.result.title+'"<\/a>',status:"success",pos:n_pos,timeout:n_timeout});notif_sound&&notif_sound.canPlayType("audio/ogg")&&notif_sound.readyState>3&&(notif_sound.onended=function(){notif_sound.src=notif_sound.src},notif_sound.play());notification_count--;break;case 4:UIkit.notification({message:'Error while processing url <a href="'+n.url+'" target="_blank">'+i+"<\/a>",status:"danger",pos:n_pos,timeout:n_timeout});notification_count--}setNotifications();n.step===2&&state.isTable&&(n.result.domain===state.data||state.data==="")&&LoadTable(state.data)});socket.on("titlechange",function(n){t_prevent_reload?t_prevent_reload=!1:state.data===n.id&&state.isDetails?LoadDetails(state.data,!0):!state.isNew&&state.isTable&&LoadTable(state.data,null)});socket.on("delete",function(n){state.data===n.id&&state.isDetails?LoadTable("",null):state.isNew||state.isDetails||LoadTable(state.data,null);UIkit.notification({message:n.message||"Deleted an item",status:"primary",pos:n_pos,timeout:n_timeout})});socket.on("notifcount",function(n){notification_count=n||0;setNotifications();setTitle(titleWithoutCount)});socket.on("disconnect",function(){notification_count="?";needs_to_reload=!0;setNotifications();setTitle(titleWithoutCount)});socket.on("error",function(n){n==="ERR_CONNECT_UNAUTHORIZED"&&location.reload()});socket.on("connect",function(){needs_to_reload&&resolveCurrent()})}Math.easeInOutQuad=function(n,t,i,r){return(n/=r/2,n<1)?i/2*n*n+t:(n--,-i/2*(n*(n-2)-1)+t)};Math.easeInCubic=function(n,t,i,r){var u=(n/=r)*n*n;return t+i*u};Math.inOutQuintic=function(n,t,i,r){var u=(n/=r)*n,f=u*n;return t+i*(6*f*u+-15*u*u+10*f)};requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}();ajax=function(n,t){var i=function(i,r){needs_to_reload=!1;var f=null,u=new XMLHttpRequest;return u.open(i,n,!0),i==="POST"&&t&&(u.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f=urlencodeFormData(t)),u.send(f),u.onreadystatechange=function(){if(u.readyState===4&&u.status>0){u.status===401&&window.location.reload();try{r(u.status,JSON.parse(u.responseText))}catch(n){r(422,{message:"Error while processing data."})}}},u.onerror=function(){DisplayError("The connection to the server timed out.");setEventListeners();setLoading(!1);needs_to_reload=!0},u};return{get:function(n){return i("GET",n)},post:function(n){return i("POST",n)}}};window.onpopstate=function(n){n&&n.state&&(state=n.state);resolveCurrent(!0)};state.data=getLastUrlElement(document.location);window.location.pathname.startsWith("/new")?(state.isNew=!0,state.data=null):window.location.pathname.startsWith("/details/")?state.isDetails=!0:state.isTable=!0;setState(state,document.title,location,!0);registerKeyboardShortcuts();setEventListeners();